CREATE DATABASE RECEPTIONIST_PROCESS
GO
USE RECEPTIONIST_PROCESS
GO
----------TẠO BẢNG VÀ PRIMARY KEY----------
CREATE TABLE KHACHHANG
(
MAKH INT IDENTITY NOT NULL,
HOTENKH NVARCHAR(30) NOT NULL,
DCHI NVARCHAR(20) NOT NULL,
GIOITINH NVARCHAR(4) NOT NULL,
SDT INT UNIQUE NOT NULL, 
CMND INT UNIQUE NOT NULL, 
QUOCTICH NVARCHAR(20),
PRIMARY KEY (MAKH)
)
GO

--DROP TABLE PHONG
CREATE TABLE PHONG
(
MAPHONG NVARCHAR(10) NOT NULL,
TENPHONG CHAR (20) NOT NULL,
TINHTRANG NVARCHAR(15) NOT NULL,
MALOAIPHONG NVARCHAR(10),
GIAPHONG INT NOT NULL,
PRIMARY KEY (MAPHONG)
)
GO

CREATE TABLE LOAIPHONG
(
MALOAIPHONG NVARCHAR(10) NOT NULL,
TENLOAIPHONG NVARCHAR(10) NOT NULL,
SOLUONG INT NOT NULL,
TRANGBI NVARCHAR(100),
PRIMARY KEY (MALOAIPHONG)
)
GO

--DROP TABLE PHIEUDICHVU
CREATE TABLE PHIEUDICHVU
(
MAPHIEUDICHVU NVARCHAR(10) NOT NULL,
TENDICHVU NVARCHAR(20) NOT NULL,
GIA INT NOT NULL,
PRIMARY KEY (MAPHIEUDICHVU)
)
GO

CREATE TABLE NHANVIEN 
(
MANV INT NOT NULL,
TENNV NVARCHAR(20) NOT NULL,
GIOITINH VARCHAR(3) NOT NULL,
NSINH DATE DEFAULT GETDATE(),
SDT INT UNIQUE NOT NULL,
DCHI NVARCHAR(20) NOT NULL,
PRIMARY KEY (MANV)
)
GO

CREATE TABLE DATPHONG 
(
MAPHIEUDAT NVARCHAR(10) NOT NULL,
MAKH INT NOT NULL,
NGAYTAO DATE NOT NULL,
NGAYTRAPHONG DATE NOT NULL,
MAPHONG NVARCHAR(10) NOT NULL,
TRATRUOC INT,
MADICHVU NVARCHAR(10),
MANV INT NOT NULL,
PRIMARY KEY (MAPHIEUDAT)
)
GO
-- NGÀY THANH TOÁN BẰNG NGÀY TRẢ PHÒNG
CREATE TABLE HOADON 
(
MAHOADON NVARCHAR(10) NOT NULL,
NGAYTHANHTOAN DATE NOT NULL,
MANV INT NOT NULL ,
MAPHIEUDATPHONG NVARCHAR(10) NOT NULL,
MADICHVU NVARCHAR(10),
TONGSOTIENPHAITRA INT NOT NULL,
PRIMARY KEY (MAHOADON)
)
GO
 
-- CHECK IN DATABASE 

ALTER TABLE KHACHHANG
ADD CONSTRAINT CK_KHACHHANG_GIOITINH CHECK
(GIOITINH=N'Nam' OR GIOITINH=N'Nữ');

ALTER TABLE NHANVIEN
ADD CONSTRAINT CK_NHANVIEN_GIOITINH CHECK
(GIOITINH=N'Nam' OR GIOITINH=N'Nữ'); --CHAY KO DC

ALTER TABLE PHONG
ADD CONSTRAINT CK_PHONG_TINHTRANG CHECK
(TINHTRANG='FULL' OR TINHTRANG='AVAILABLE');

ALTER TABLE PHONG
ADD CONSTRAINT CK_PHONG_GIAPHONG CHECK (GIAPHONG>=0);

ALTER TABLE PHIEUDICHVU
ADD CONSTRAINT CK_DICHVU_GIA CHECK (GIA>=0);

ALTER TABLE HOADON
ADD CONSTRAINT CK_HOADON_TONGTIEN CHECK (TONGSOTIENPHAITRA>=0);


-----------TẠO FOREIGN KEY----------
--DROP CONSTRAINT FK_DATPHONG_PHONG;
ALTER TABLE DATPHONG  ADD CONSTRAINT FK_DATPHONG_PHONG 
FOREIGN KEY (MAPHONG) REFERENCES PHONG(MAPHONG)

ALTER TABLE DATPHONG  ADD CONSTRAINT FK_DATPHONG_KHACHHANG
FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH)

ALTER TABLE DATPHONG  ADD CONSTRAINT FK_DATPHONG_NHANVIEN
FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV)

--DROP CONSTRAINT FK_PHONG_LOAIPHONG ;
ALTER TABLE PHONG  ADD CONSTRAINT FK_PHONG_LOAIPHONG 
FOREIGN KEY (MALOAIPHONG) REFERENCES LOAIPHONG(MALOAIPHONG)

ALTER TABLE HOADON  ADD CONSTRAINT FK_HOADON_NHANVIEN
FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV)

ALTER TABLE HOADON  ADD CONSTRAINT FK_HOADON_DATPHONG
FOREIGN KEY (MAPHIEUDATPHONG) REFERENCES DATPHONG(MAPHIEUDAT)

ALTER TABLE HOADON  ADD CONSTRAINT FK_HOADON_PHIEUDICHVU
FOREIGN KEY (MADICHVU) REFERENCES PHIEUDICHVU(MAPHIEUDICHVU)

ALTER TABLE DATPHONG ADD CONSTRAINT FK_DATPHONG_PHIEUDICHVU
FOREIGN KEY (MADICHVU) REFERENCES PHIEUDICHVU(MAPHIEUDICHVU)

SET IDENTITY_INSERT KHACHHANG ON;
SET IDENTITY_INSERT HOADON ON;
SET IDENTITY_INSERT NHANVIEN ON;
SET IDENTITY_INSERT DATPHONG ON;
SET IDENTITY_INSERT PHIEUDICHVU ON;
SET IDENTITY_INSERT PHONG ON;
SET IDENTITY_INSERT LOAIPHONG ON;


----------TẠO THÔNG TIN ĐỂ TRUY VẤN----------
SELECT *FROM KHACHHANG
INSERT INTO KHACHHANG (MAKH, HOTENKH, DCHI, GIOITINH, SDT, CMND, QUOCTICH)
VALUES
(001, N'Nguyễn Thị Kim Quyên', N'Long An', N'Nữ', 0352251421, 053000478, N'Việt Nam'),
(002, N'Nguyễn Mạnh Hùng', N'Bến Tre', N'Nam', 0913055113, 053000123, N'Việt Nam'),
(003, N'Nguyễn Nhựt Trường', N'Cà Mau', N'Nam', 0584866644, 053000598, N'Việt Nam'),
(004, N'Phạm Thanh Hằng', N'Tây Ninh', N'Nữ', 0347856876, 053000452, N'Việt Nam'),
(005, N'Trần Tuấn Minh', N'Tp.Hồ Chí Minh', N'Nam', 0598388093, 053000693, N'Việt Nam'),
(006, N'Nguyễn Thị Như Quỳnh', N'Bắc Ninh', N'Nữ', 0917936773, 053000119, N'Việt Nam'),
(007, N'Tôn Nữ Thanh Tuyền', N'Long An', N'Nữ', 0931891477, 053000456, N'Việt Nam'),
(008, N'Lê Thanh Xuân', N'Tp.Hồ Chí Minh', N'Nam', 0896163663, 053000978, N'Việt Nam'),
(009, N'Phan Quốc Vinh', N'Hà Nội', N'Nam', 0248880359, 053000790, N'Việt Nam'),
(010, N'Đặng Thị Ngọc Hoa', N'Đà Nẵng', N'Nữ', 0932488962, 053000677, N'Việt Nam')

SELECT * FROM PHONG
DELETE FROM PHONG
INSERT INTO PHONG(MAPHONG, TENPHONG, TINHTRANG, MALOAIPHONG, GIAPHONG)
VALUES 
(881, 'A01', 'AVAILABLE', '991', 600000),
(882, 'A02', 'AVAILABLE', '991', 600000),
(883, 'A03', 'AVAILABLE', '991', 600000),
(884, 'A04', 'AVAILABLE', '991', 600000),
(885, 'A05', 'AVAILABLE', '991', 600000),
(886, 'A05', 'AVAILABLE', '991', 600000),
(887, 'A06', 'AVAILABLE', '991', 600000),
(888, 'A07', 'AVAILABLE', '991', 600000),
(889, 'A08', 'AVAILABLE', '991', 600000),
(890, 'B01', 'AVAILABLE', '992', 840000),
(891, 'B02', 'AVAILABLE', '992', 840000),
(892, 'B03', 'AVAILABLE', '992', 840000),
(893, 'B04', 'AVAILABLE', '992', 840000),
(894, 'B05', 'AVAILABLE', '992', 840000),
(895, 'B06', 'AVAILABLE', '992', 840000),
(896, 'B07', 'AVAILABLE', '992', 840000),
(897, 'C01', 'AVAILABLE', '993', 3000000),
(898, 'C02', 'AVAILABLE', '993', 3000000),
(899, 'C03', 'AVAILABLE', '993', 3000000),
(900, 'C04', 'AVAILABLE', '993', 3000000),
(901, 'C05', 'AVAILABLE', '993', 3000000)

SELECT * FROM LOAIPHONG
INSERT INTO LOAIPHONG(MALOAIPHONG, TENLOAIPHONG, SOLUONG, TRANGBI)
VALUES
(991, 'Standard', 8, N'Diện tích 13-16m2, giường đôi, máy lạnh, kệ tivi, phòng tắm, tủ'),
(992, 'Superior', 7, N'Diện tích 16-18m2, giường đôi, máy lạnh, kệ ti vi, phòng tắm, tủ, sofa, bàn làm việc'),
(993, 'Deluxe', 5, N'Diện tích 32-36m2, có nhiều phòng, đầy đủ tiện nghi, view hướng ra biển, núi')

--DELETE FROM PHIEUDICHVU
SELECT * FROM PHIEUDICHVU
INSERT INTO PHIEUDICHVU (MAPHIEUDICHVU, TENDICHVU, GIA)
VALUES
('VU01', N'Giặt ủi', 100000),
('VU02', N'Gym', 200000),
('VU03', N'Spa', 200000),
('VU04', N'Karaoke', 300000),
('VU05', N'Thuê xe', 200000),
('VU06', N'Trông trẻ', 100000),
('VU07', N'Casino', 300000),
('VU08', N'Thể thao', 200000),
('VU09', N'Phục vụ 24/24', 500000),
('VU10', N'Đặt vé', 100000)

DELETE FROM NHANVIEN
SELECT * FROM NHANVIEN
INSERT INTO NHANVIEN(MANV, TENNV, GIOITINH, NSINH, SDT, DCHI)
VALUES
(111, N'Diểm Thuy', N'Nữ', '2003-10-01', 0783651179, N'Long An'),
(112, N'Mỹ Duyên', N'Nữ', '1986-09-14', 0933563217, N'Tp.Hồ Chí Minh'),
(113, N'Tấn Phát', N'Nam', '2001-12-24', 0775610840,N'Tp.Hồ Chí Minh'),
(114, N'Thu Trang', N'Nữ', '1999-06-01', 0249954553, N'Tây Ninh'),
(115, N'Mỹ Tiên', N'Nữ', '1993-09-21', 0909989055, N'Bình Dương'),
(116, N'Phát Đạt', N'Nam', '2004-10-23', 0784961169, N'Đồng Nai'),
(117, N'Tuấn Cường', N'Nam', '1994-10-26', 0916055119, N'Quảng Ngải'),
(118, N'Như Ý', N'Nữ', '1998-11-01', 0933567017, N'Hà Nội'),
(119, N'Thảo Mai', N'Nữ', '1997-02-04', 0915088666, N'Cà Mau'),
(120, N'Duy Hải', N'Nam', '1995-07-26', 0763671179, N'Hà Tĩnh')

--DELETE FROM DATPHONG
SELECT * FROM DATPHONG
INSERT INTO DATPHONG(MAPHIEUDAT, MAKH, NGAYTAO, NGAYTRAPHONG, MAPHONG, TRATRUOC, MADICHVU, MANV)
VALUES
('PD1', 001, '2023-02-14 ', '2023-02-20', 881, 200000, NULL, 116),
('PD2', 002, '2023-04-30', '2023-05-05', 901, 1000000, 'VU05', 112),
('PD3', 003, '2023-02-11', '2023-02-13', 889, 300000, 'VU01', 116),
('PD4', 004, '2023-03-19', '2023-03-20', 883, 200000, 'VU02', 114),
('PD5', 005, '2023-02-28', '2023-03-03', 894, 300000, 'VU07', 115),
('PD6', 006, '2023-03-01', '2023-03-10', 900, 1000000, 'VU06', 111),
('PD7', 007, '2023-03-01', '2023-03-09', 885, 200000, NULL, 111),
('PD8', 008, '2023-02-11', '2023-02-19', 886, 200000, 'VU03', 114),
('PD9', 009, '2023-03-01', '2023-03-04', 895, 300000, 'VU04', 115),
('PD10', 010,'2023-04-02', '2023-04-04', 882, 200000, NULL, 115),
('PD11', 005, '2023-02-28', '2023-03-03', 887, 600000, 'VU10', 113),
('PD12', 001, '2023-02-14 ', '2023-02-20', 899, 1000000, 'VU09', 115)

SELECT * FROM HOADON
INSERT INTO HOADON(MAHOADON, MAPHIEUDATPHONG, MANV, NGAYTHANHTOAN, MADICHVU, TONGSOTIENPHAITRA)
VALUES
('HD1', 'PD1', 116, '2023-02-20', NULL, 600000),
('HD2', 'PD2', 112, '2023-04-30', 'VU05', 3200000),
('HD3', 'PD3', 116, '2023-02-13', 'VU01', 850000),
('HD4', 'PD4', 114,  '2023-03-20', 'VU02', 800000),
('HD5', 'PD5', 115,  '2023-03-03', 'VU07', 1140000),
('HD6', 'PD6', 111,  '2023-03-01', 'VU06', 3100000),
('HD7', 'PD7', 111,  '2023-03-09', NULL, 600000),
('HD8', 'PD8', 114,  '2023-02-19', 'VU03', 800000),
('HD9', 'PD9', 115, '2023-03-04', 'VU04', 1140000),
('HD10','PD10', 115, '2023-04-04', NULL, 600000),
('HD11', 'PD11', 113, '2023-02-28', 'VU10', 850000),
('HD12', 'PD12', 115, '2023-02-20', 'VU09', 3500000)

-- PROCEDUCE INSERT THÔNG TIN KHÁCH HÀNG MỚI VÀO BẢNG KHÁCH HÀNG

SET IDENTITY_INSERT KHACHHANG  ON
GO
CREATE PROCEDURE PCD_insert_KHACHHANG
(
@MAKH INT,
@HOTENKH NVARCHAR(30),
@DCHI NVARCHAR(20),
@GIOITINH NVARCHAR(4),
@SDT INT, 
@CMND INT, 
@QUOCTICH NVARCHAR(20)
)
AS
BEGIN
INSERT INTO KHACHHANG
(MAKH,HOTENKH,DCHI,GIOITINH,SDT, CMND, QUOCTICH)VALUES
(@MAKH,@HOTENKH,@DCHI,@GIOITINH,@SDT, @CMND, @QUOCTICH)
END

EXEC PCD_insert_KHACHHANG 022, 'Trương Thị Anh Thư', 'Bình Định', N'Nữ', 09071110, 301828, 'Việt Nam'
EXEC PCD_insert_KHACHHANG 023, 'Lê Thị Năm', 'Bạc Liêu', N'Nữ', 06846511, 3018673, 'Việt Nam'
EXEC PCD_insert_KHACHHANG 024, 'Trần Bảo Tuyết', 'Thanh Hóa', N'Nữ', 09080700, 3067297, 'Việt Nam'
EXEC PCD_insert_KHACHHANG 025, 'Trịnh Bách Nam', 'Quảng Ninh', N'Nam', 09781117, 3018280, 'Việt Nam'
EXEC PCD_insert_KHACHHANG 026, 'Lê Tuấn Khôi', 'TP.Hồ Chí Minh', N'Nam', 09335611, 308954, 'Việt Nam'

--PROCEDURE INSERT THÔNG TIN NHÂN VIÊN MỚI VÀO BẢNG NHÂN VIÊN
CREATE PROCEDURE PCD_insert_NHANVIEN
(
@MANV INT,
@TENNV NVARCHAR(20),
@GIOITINH VARCHAR(3),
@NSINH DATE,
@SDT INT,
@DCHI NVARCHAR(20)
)
AS
BEGIN
INSERT INTO KHACHHANG(MANV,TENNV,GIOITINH,NSINH,SDT,DCHI)VALUES
(@MANV,@TENNV,@GIOITINH,@NSINH,@SDT,@DCHI)
END

EXEC PCD_insert_NHANVIEN 121, 'Nguyễn Minh Hiếu', N'Nam', '21-07-2004', 0913055119, 'An Giang'
EXEC PCD_insert_NHANVIEN 122, 'Trần Minh Giàu', N'Nam', '2001-01-19', 06784451245, 'Nghệ An'
EXEC PCD_insert_NHANVIEN 123, 'Nguyễn Khánh Duy', N'Nam', '1999-07-26', 0913654111, 'Thanh Hóa'
EXEC PCD_insert_NHANVIEN 124, 'Trần Thị Ngọc Minh', N'Nữ', '1989-08-30', 0907080044, 'Hà Nội'
EXEC PCD_insert_NHANVIEN 125, 'Nguyễn Thị Hồng Nguyên', N'Nữ', '1997-07-19', 0901323675, 'Long An' 


-- PROCEDURE QUY TRÌNH ĐẶT PHÒNG NHẬP DỮ LIỆU VÀO BẢNG DATPHONG VÀ SET TÌNH TRẠNG AVAILABLE SANG FULL
CREATE PROCEDURE PCD_DATPHONG_NHAPDULIEU
(
@MAPHIEUDAT NVARCHAR(10) ,
@MAKH INT,
@NGAYTAO DATE,
@NGAYTRAPHONG DATE,
@MAPHONG NVARCHAR(10),
@TRATRUOC INT,
@MADICHVU NVARCHAR(10),
@MANV INT
)
AS
BEGIN
INSERT INTO DATPHONG
(MAPHIEUDAT,MAKH,NGAYTAO,NGAYTRAPHONG,MAPHONG,TRATRUOC,MADICHVU,MANV) VALUES
(@MAPHIEUDAT,@MAKH,@NGAYTAO,@NGAYTRAPHONG,@MAPHONG,@TRATRUOC,@MADICHVU,@MANV)
UPDATE PHONG SET TINHTRANG='FULL' WHERE @MAPHONG=MAPHONG
END
 
EXEC PCD_DATPHONG_NHAPDULIEU 'PD13', 022,'2023-04-30','2023-05-19', '881', 200000, 'VU09', 125
EXEC PCD_DATPHONG_NHAPDULIEU 'PD14', 023, '2023-05-01', '2023-05-10', '885', 1000000, 'VU06', 121
EXEC PCD_DATPHONG_NHAPDULIEU 'PD15', 024, '2023-06-18', '2023-06-20', '901', 300000, 'VU06', 124
EXEC PCD_DATPHONG_NHAPDULIEU 'PD16', 025, '2023-05-29', '2023-06-02', '888', 500000, 'VU05', 123
EXEC PCD_DATPHONG_NHAPDULIEU 'PD17', 026, '2023-04-13', '2023-04-15', '889', 2000000, 'VU07', 122 

-- PROCEDURE THANH TOÁN HÓA ĐƠN VÀ LƯU VÔ BẢNG HÓA ĐƠN (SET TÌNH TRẠNG TỪ FULL SANG AVAILABLE
CREATE PROCEDURE HOANTAT_THANHTOAN
(
@MAHOADON NVARCHAR(10),
@MAPHONG NVARCHAR(10),
@NGAYTHANHTOAN DATE,
@SOTIENTRATRUOC INT,
@MANV INT,
@MAPHIEUDATPHONG NVARCHAR(10),
@MADICHVU NVARCHAR(10),
@TONGSOTIENPHAITRA INT 
)
AS
BEGIN
DECLARE @TONGTIEN FLOAT = (SELECT (SUM(PHIEUDICHVU.GIA)+SUM(PHONG.GIAPHONG))-DATPHONG.TRATRUOC FROM DATPHONG 
JOIN PHONG ON PHONG.MAPHONG = DATPHONG.MAPHONG 
JOIN PHIEUDICHVU ON PHIEUDICHVU.MAPHIEUDICHVU = DATPHONG.MADICHVU
WHERE DATPHONG.MAPHONG=@MAPHONG)
INSERT INTO HOADON
(MAHOADON,NGAYTHANHTOAN,SOTIENTRATRUOC,MANV,MAPHIEUDATPHONG,MADICHVU,TONGSOTIENPHAITRA)
VALUES
(@MAHOADON,@NGAYTHANHTOAN,@SOTIENTRATRUOC,@MANV,@MAPHIEUDATPHONG,@MADICHVU,@TONGSOTIENPHAITRA)
UPDATE PHONG SET TINHTRANG='AVAILABLE' WHERE @MAPHONG=MAPHONG
END

EXEC HOANTAT_THANHTOAN 'HD13', '881', '2023-05-19', 200000, 125, 'VU09', 'PD13', 610000
EXEC HOANTAT_THANHTOAN 'HD14', '885', '2023-05-10', 1000000, 121, 'PD14', 'VU06', 850000
EXEC HOANTAT_THANHTOAN 'HD15', '901', '2023-06-20', 300000, 124, 'PD15', 'VU06', 3100000
EXEC HOANTAT_THANHTOAN 'HD16', '888', '2023-06-02', 500000, 123, 'PD16', 'VU05', 860000
EXEC HOANTAT_THANHTOAN 'HD17', '889', '2023-04-15', 500000, 122, 'PD17', 'VU07', 870000

----------CÁC CÂU QUERY----------
SELECT * FROM KHACHHANG
SELECT * FROM PHONG
SELECT * FROM LOAIPHONG
SELECT * FROM NHANVIEN
SELECT * FROM PHIEUDICHVU
SELECT * FROM DATPHONG
SELECT * FROM HOADON

--Còn bao nhiêu phòng trống
SELECT COUNT(*) AS N'SỐ LƯỢNG PHÒNG TRỐNG' FROM PHONG
WHERE TINHTRANG = 'AVAILABLE'

--Tìm tên phòng va những khách đặt vào ngày 03/01/2023
SELECT KHACHHANG.HOTENKH AS N'HỌ TÊN KHÁCH HÀNG', PHONG.TENPHONG AS N'TÊN PHÒNG', DATPHONG.NGAYTAO AS N'NGÀY ĐẶT PHÒNG' FROM DATPHONG
JOIN KHACHHANG ON DATPHONG.MAKH = KHACHHANG.MAKH
JOIN PHONG ON DATPHONG.MAPHONG = PHONG.MAPHONG
WHERE NGAYTAO = '03/01/2023'

--Tìm phòng có tên B03
SELECT * FROM PHONG 
WHERE TENPHONG ='B03'

--Phòng Superior có trang bị như thế nào
SELECT TENLOAIPHONG, TRANGBI FROM LOAIPHONG
WHERE TENLOAIPHONG = 'Superior'

--Tìm giá, số lượng và trang bị của các loại phòng Standard, Superior, Deluxe
SELECT LOAIPHONG.SOLUONG, LOAIPHONG.TENLOAIPHONG, LOAIPHONG.TRANGBI, PHONG.GIAPHONG FROM LOAIPHONG
JOIN PHONG ON LOAIPHONG.MALOAIPHONG = PHONG.MALOAIPHONG
GROUP BY SOLUONG, TENLOAIPHONG, TRANGBI, GIAPHONG

--Khách sạn bao gồm những dịch vụ nào và hiển thị giá của nó
SELECT * FROM PHIEUDICHVU

--Tìm tìm thông tin khách hàng đã đặt phòng ‘A08’ (Tên, SDT, CMND, Địa Chỉ)
SELECT KHACHHANG.HOTENKH, KHACHHANG.CMND, KHACHHANG.SDT, KHACHHANG.DCHI, PHONG.TENPHONG FROM DATPHONG
JOIN PHONG ON DATPHONG.MAPHONG = PHONG.MAPHONG
JOIN KHACHHANG ON DATPHONG.MAKH = KHACHHANG.MAKH
WHERE PHONG.TENPHONG = 'A08'

--Tìm những khách hàng sử dụng dịch vụ Thuê xe, Giặt ủi, Spa, Đặt vé, Karaoke,... và hiển thị giá của các dịch vụ đó
SELECT KHACHHANG.HOTENKH, PHIEUDICHVU.TENDICHVU, PHIEUDICHVU.GIA FROM DATPHONG
JOIN PHIEUDICHVU ON DATPHONG.MADICHVU = PHIEUDICHVU.MAPHIEUDICHVU
JOIN KHACHHANG ON DATPHONG.MAKH = KHACHHANG.MAKH

--Tìm những khách hàng đặt hơn 1 phòng (nhiều phòng)--
SELECT KHACHHANG.HOTENKH, COUNT(*) AS 'Số phòng khách đã đặt' FROM DATPHONG
JOIN KHACHHANG ON DATPHONG.MAKH = KHACHHANG.MAKH
GROUP BY KHACHHANG.HOTENKH
HAVING COUNT(*) > 1

--Tìm các khách hàng trả trước 1 triệu đồng (1000000), ngày trả trước và nhân viên nào quản lý những khách hàng đó
SELECT KHACHHANG.HOTENKH, DATPHONG.TRATRUOC AS N'SỐ TIỀN TRẢ TRƯỚC', DATPHONG.NGAYTAO AS N'NGÀY TRẢ TRƯỚC', PHONG.TENPHONG FROM DATPHONG
JOIN KHACHHANG ON DATPHONG.MAKH = KHACHHANG.MAKH
JOIN NHANVIEN ON DATPHONG.MANV = NHANVIEN.MANV
JOIN PHONG ON DATPHONG.MAPHONG = PHONG.MAPHONG
WHERE TRATRUOC = '1000000'

--Tìm khách hàng đặt phòng vào ngày 11/02/2023 (TAOPHONG), trả trước 300.000 đồng và khách hàng đó sử dụng dịch vụ gì
SELECT KHACHHANG.HOTENKH, DATPHONG.NGAYTAO AS N'NGÀY ĐẶT HÀNG', DATPHONG.TRATRUOC AS N'SỐ TIỀN TRẢ TRƯỚC', PHIEUDICHVU.TENDICHVU FROM DATPHONG
JOIN KHACHHANG ON DATPHONG.MAKH = KHACHHANG.MAKH
JOIN PHIEUDICHVU ON DATPHONG.MADICHVU = PHIEUDICHVU.MAPHIEUDICHVU
WHERE DATPHONG.NGAYTAO = '2023-02-11' AND DATPHONG.TRATRUOC = '300000'

--Tìm khách hàng đặt phòng Superior, hiển thị trang bị và giá của phòng đó
SELECT KHACHHANG.HOTENKH, LOAIPHONG.TENLOAIPHONG, LOAIPHONG.TRANGBI, PHONG.GIAPHONG FROM DATPHONG
JOIN PHONG ON PHONG.MAPHONG = DATPHONG.MAPHONG
JOIN LOAIPHONG ON PHONG.MALOAIPHONG = LOAIPHONG.MALOAIPHONG
JOIN KHACHHANG ON DATPHONG.MAKH = KHACHHANG.MAKH
WHERE PHONG.MALOAIPHONG = '992'

--Tìm những khách hàng trả phòng vào ngày 03/03/2023 và tên nhân viên quản lý khách hàng đó
SELECT KHACHHANG.HOTENKH, DATPHONG.NGAYTRAPHONG, NHANVIEN.TENNV FROM DATPHONG
JOIN KHACHHANG ON DATPHONG.MAKH = KHACHHANG.MAKH
JOIN NHANVIEN ON DATPHONG.MANV = NHANVIEN.MANV
WHERE DATPHONG.NGAYTRAPHONG = '2023-03-03'

--Khách hàng đã trả những phòng nào, đếm số lượng các phòng khách hàng đã trả và những phòng đó chuyển về trạng thái còn trống
SELECT KHACHHANG.HOTENKH,TENPHONG, COUNT(TINHTRANG) AS N'Số phòng khách đã trả' , PHONG.TINHTRANG FROM DATPHONG
JOIN PHONG ON PHONG.MAPHONG = DATPHONG.MAPHONG
JOIN LOAIPHONG ON PHONG.MALOAIPHONG = LOAIPHONG.MALOAIPHONG
JOIN KHACHHANG ON DATPHONG.MAKH = KHACHHANG.MAKH
WHERE TINHTRANG = 'AVAILABLE'
GROUP BY TENPHONG, KHACHHANG.HOTENKH, PHONG.TINHTRANG

--Lọc danh sách khách hàng đặt phòng trong quý 1 (bắt đầu từ tháng 1 đến hết tháng 3)--
SELECT KHACHHANG.HOTENKH, DATPHONG.NGAYTAO FROM DATPHONG 
JOIN KHACHHANG ON DATPHONG.MAKH = KHACHHANG.MAKH
WHERE MONTH(DATPHONG.NGAYTAO) > 1 AND MONTH(DATPHONG.NGAYTAO) <= 3

--Hiển thị chi tiết hóa đơn ‘HD10’ bao gồm tên khách hàng, nhân viên quản lý khách hàng đó, dịch vụ -- 
SELECT KHACHHANG.HOTENKH, NHANVIEN.TENNV, PHIEUDICHVU.TENDICHVU  FROM DATPHONG
JOIN KHACHHANG ON DATPHONG.MAKH = KHACHHANG.MAKH
JOIN HOADON ON DATPHONG.MAPHIEUDAT = HOADON.MAPHIEUDATPHONG
JOIN NHANVIEN ON DATPHONG.MANV = NHANVIEN.MANV
JOIN PHIEUDICHVU ON DATPHONG.MADICHVU = PHIEUDICHVU.MAPHIEUDICHVU
WHERE HOADON.MAHOADON = 'HD1'
GROUP BY KHACHHANG.HOTENKH, NHANVIEN.TENNV, PHIEUDICHVU.TENDICHVU
SELECT * FROM HOADON

--Tra cứu hóa đơn của khách hàng có thanh toán hóa đơn vào ngày 13/02/2023 bao gồm CMND, nhân viên, tổng số tiền phải trả  
SELECT KHACHHANG.HOTENKH, KHACHHANG.CMND, NHANVIEN.TENNV, HOADON.TONGSOTIENPHAITRA, HOADON.NGAYTHANHTOAN FROM DATPHONG
JOIN KHACHHANG ON DATPHONG.MAKH = DATPHONG.MAKH
JOIN PHIEUDICHVU ON DATPHONG.MADICHVU = PHIEUDICHVU.MAPHIEUDICHVU
JOIN HOADON ON DATPHONG.MAPHIEUDAT = HOADON.MAPHIEUDATPHONG
JOIN PHONG ON DATPHONG.MAPHONG = PHONG.MAPHONG
JOIN NHANVIEN ON DATPHONG.MANV = NHANVIEN.MANV
WHERE HOADON.NGAYTHANHTOAN ='2023-02-13' 
GROUP BY KHACHHANG.HOTENKH, KHACHHANG.CMND, NHANVIEN.TENNV, HOADON.TONGSOTIENPHAITRA, HOADON.NGAYTHANHTOAN
SELECT * FROM HOADON

--Hãy cho biết khách hàng có tên Phan Quốc Vinh ở bao nhiêu ngày
SELECT  DATEDIFF(day, '2023-03-01', '2023-03-04') AS N'Số ngày khách ở',KHACHHANG.HOTENKH, DATPHONG.NGAYTAO,DATPHONG.NGAYTRAPHONG FROM DATPHONG
JOIN KHACHHANG ON DATPHONG.MAKH = KHACHHANG.MAKH
WHERE DATPHONG.MAKH = '009'
GROUP BY KHACHHANG.HOTENKH, DATPHONG.NGAYTAO,DATPHONG.NGAYTRAPHONG

--Tra cứu tổng tiền hóa đơn bao gồm: tiền phòng, tiền dịch vụ, ngày thanh toán, mã nhân viên quản lý hóa đơn ‘HD6’ 
SELECT KHACHHANG.MAKH, KHACHHANG.HOTENKH, HOADON.MAHOADON,  HOADON.NGAYTHANHTOAN, HOADON.MANV,  PHONG.GIAPHONG, PHIEUDICHVU.GIA, DATPHONG.TRATRUOC, (SUM(PHIEUDICHVU.GIA)+SUM(PHONG.GIAPHONG))-DATPHONG.TRATRUOC AS N'TONG TIEN' FROM DATPHONG
JOIN KHACHHANG ON DATPHONG.MAKH = DATPHONG.MAKH
JOIN PHIEUDICHVU ON DATPHONG.MADICHVU = PHIEUDICHVU.MAPHIEUDICHVU
JOIN HOADON ON DATPHONG.MAPHIEUDAT = HOADON.MAPHIEUDATPHONG
JOIN PHONG ON DATPHONG.MAPHONG = PHONG.MAPHONG
WHERE HOADON.MAHOADON ='HD6' 
GROUP BY PHONG.GIAPHONG, PHIEUDICHVU.GIA, HOADON.NGAYTHANHTOAN, HOADON.MANV, KHACHHANG.MAKH,  HOADON.MAHOADON,KHACHHANG.HOTENKH,  DATPHONG.TRATRUOC


-- VIEW 
-- TẠO VIEW XEM NHANVIEN NÀO PHỤ TRÁCH PHIEUDATPHONG NÀO
CREATE VIEW hotel_employees AS
	SELECT TENNV, MAPHIEUDAT, NGAYTAO AS NGAYDAT, MAPHONG
	FROM NHANVIEN
	JOIN DATPHONG
	ON NHANVIEN.MANV = DATPHONG.MANV;

select * from hotel_employees

-- TẠO VIEW XEM KHACHHANG DAT PHONG NÀO VÀO NGÀY NÀO
CREATE VIEW hotel_guests AS
SELECT KHACHHANG.MAKH, HOTENKH, DCHI, GIOITINH, SDT, QUOCTICH, DATPHONG.MAPHIEUDAT, DATPHONG.NGAYTRAPHONG, DATPHONG.MAPHONG
FROM KHACHHANG
JOIN DATPHONG ON KHACHHANG.MAKH = DATPHONG.MAKH

select * from hotel_guests

-- PROCEDUCE INSERT THÔNG TIN KHÁCH HÀNG MỚI VÀO BẢNG KHÁCH HÀNG

SET IDENTITY_INSERT KHACHHANG  ON
GO
CREATE PROCEDURE PCD_insert_KHACHHANG
(
@MAKH INT,
@HOTENKH NVARCHAR(30),
@DCHI NVARCHAR(20),
@GIOITINH NVARCHAR(4),
@SDT INT, 
@CMND INT, 
@QUOCTICH NVARCHAR(20)
)
AS
BEGIN
INSERT INTO KHACHHANG
(MAKH,HOTENKH,DCHI,GIOITINH,SDT, CMND, QUOCTICH)VALUES
(@MAKH,@HOTENKH,@DCHI,@GIOITINH,@SDT, @CMND, @QUOCTICH)
END

EXEC PCD_insert_KHACHHANG 022, 'Trương Thị Anh Thư', 'Bình Định', N'Nữ', 09071110, 301828, 'Việt Nam'
EXEC PCD_insert_KHACHHANG 023, 'Lê Thị Năm', 'Bạc Liêu', N'Nữ', 06846511, 3018673, 'Việt Nam'
EXEC PCD_insert_KHACHHANG 024, 'Trần Bảo Tuyết', 'Thanh Hóa', N'Nữ', 09080700, 3067297, 'Việt Nam'
EXEC PCD_insert_KHACHHANG 025, 'Trịnh Bách Nam', 'Quảng Ninh', N'Nam', 09781117, 3018280, 'Việt Nam'
EXEC PCD_insert_KHACHHANG 026, 'Lê Tuấn Khôi', 'TP.Hồ Chí Minh', N'Nam', 09335611, 308954, 'Việt Nam'

--PROCEDURE INSERT THÔNG TIN NHÂN VIÊN MỚI VÀO BẢNG NHÂN VIÊN
CREATE PROCEDURE PCD_insert_NHANVIEN
(
@MANV INT,
@TENNV NVARCHAR(20),
@GIOITINH VARCHAR(3),
@NSINH DATE,
@SDT INT,
@DCHI NVARCHAR(20)
)
AS
BEGIN
INSERT INTO KHACHHANG(MANV,TENNV,GIOITINH,NSINH,SDT,DCHI)VALUES
(@MANV,@TENNV,@GIOITINH,@NSINH,@SDT,@DCHI)
END

EXEC PCD_insert_NHANVIEN 121, 'Nguyễn Minh Hiếu', N'Nam', '21-07-2004', 0913055119, 'An Giang'
EXEC PCD_insert_NHANVIEN 122, 'Trần Minh Giàu', N'Nam', '2001-01-19', 06784451245, 'Nghệ An'
EXEC PCD_insert_NHANVIEN 123, 'Nguyễn Khánh Duy', N'Nam', '1999-07-26', 0913654111, 'Thanh Hóa'
EXEC PCD_insert_NHANVIEN 124, 'Trần Thị Ngọc Minh', N'Nữ', '1989-08-30', 0907080044, 'Hà Nội'
EXEC PCD_insert_NHANVIEN 125, 'Nguyễn Thị Hồng Nguyên', N'Nữ', '1997-07-19', 0901323675, 'Long An' 


-- PROCEDURE QUY TRÌNH ĐẶT PHÒNG NHẬP DỮ LIỆU VÀO BẢNG DATPHONG VÀ SET TÌNH TRẠNG AVAILABLE SANG FULL
CREATE PROCEDURE PCD_DATPHONG_NHAPDULIEU
(
@MAPHIEUDAT NVARCHAR(10) ,
@MAKH INT,
@NGAYTAO DATE,
@NGAYTRAPHONG DATE,
@MAPHONG NVARCHAR(10),
@TRATRUOC INT,
@MADICHVU NVARCHAR(10),
@MANV INT
)
AS
BEGIN
INSERT INTO DATPHONG
(MAPHIEUDAT,MAKH,NGAYTAO,NGAYTRAPHONG,MAPHONG,TRATRUOC,MADICHVU,MANV) VALUES
(@MAPHIEUDAT,@MAKH,@NGAYTAO,@NGAYTRAPHONG,@MAPHONG,@TRATRUOC,@MADICHVU,@MANV)
UPDATE PHONG SET TINHTRANG='FULL' WHERE @MAPHONG=MAPHONG
END
 
EXEC PCD_DATPHONG_NHAPDULIEU 'PD13', 022,'2023-04-30','2023-05-19', '881', 200000, 'VU09', 125
EXEC PCD_DATPHONG_NHAPDULIEU 'PD14', 023, '2023-05-01', '2023-05-10', '885', 1000000, 'VU06', 121
EXEC PCD_DATPHONG_NHAPDULIEU 'PD15', 024, '2023-06-18', '2023-06-20', '901', 300000, 'VU06', 124
EXEC PCD_DATPHONG_NHAPDULIEU 'PD16', 025, '2023-05-29', '2023-06-02', '888', 500000, 'VU05', 123
EXEC PCD_DATPHONG_NHAPDULIEU 'PD17', 026, '2023-04-13', '2023-04-15', '889', 2000000, 'VU07', 122 

-- PROCEDURE THANH TOÁN HÓA ĐƠN VÀ LƯU VÔ BẢNG HÓA ĐƠN (SET TÌNH TRẠNG TỪ FULL SANG AVAILABLE
CREATE PROCEDURE HOANTAT_THANHTOAN
(
@MAHOADON NVARCHAR(10),
@MAPHONG NVARCHAR(10),
@NGAYTHANHTOAN DATE,
@SOTIENTRATRUOC INT,
@MANV INT,
@MAPHIEUDATPHONG NVARCHAR(10),
@MADICHVU NVARCHAR(10),
@TONGSOTIENPHAITRA INT 
)
AS
BEGIN
DECLARE @TONGTIEN FLOAT = (SELECT (SUM(PHIEUDICHVU.GIA)+SUM(PHONG.GIAPHONG))-DATPHONG.TRATRUOC FROM DATPHONG 
JOIN PHONG ON PHONG.MAPHONG = DATPHONG.MAPHONG 
JOIN PHIEUDICHVU ON PHIEUDICHVU.MAPHIEUDICHVU = DATPHONG.MADICHVU
WHERE DATPHONG.MAPHONG=@MAPHONG)
INSERT INTO HOADON
(MAHOADON,NGAYTHANHTOAN,SOTIENTRATRUOC,MANV,MAPHIEUDATPHONG,MADICHVU,TONGSOTIENPHAITRA)
VALUES
(@MAHOADON,@NGAYTHANHTOAN,@SOTIENTRATRUOC,@MANV,@MAPHIEUDATPHONG,@MADICHVU,@TONGSOTIENPHAITRA)
UPDATE PHONG SET TINHTRANG='AVAILABLE' WHERE @MAPHONG=MAPHONG
END

EXEC HOANTAT_THANHTOAN 'HD13', '881', '2023-05-19', 200000, 125, 'VU09', 'PD13', 610000
EXEC HOANTAT_THANHTOAN 'HD14', '885', '2023-05-10', 1000000, 121, 'PD14', 'VU06', 850000
EXEC HOANTAT_THANHTOAN 'HD15', '901', '2023-06-20', 300000, 124, 'PD15', 'VU06', 3100000
EXEC HOANTAT_THANHTOAN 'HD16', '888', '2023-06-02', 500000, 123, 'PD16', 'VU05', 860000
EXEC HOANTAT_THANHTOAN 'HD17', '889', '2023-04-15', 500000, 122, 'PD17', 'VU07', 870000

